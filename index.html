<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="pb-20">

<header>
    <div class="header-main">
        <div id="api-status" class="api-status api-connecting">
            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
            Connecting...
        </div>
        <button onclick="App.refreshData()" class="wallet-btn" id="refreshBtn">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
            </svg>
        </button>
    </div>
</header>

<div class="main-container">
    
    <div class="chart-section px-3" id="chartSection">
        <div class="chart-slider" id="chartSlider">
            
            <div class="portfolio-view">
                <div class="doughnut-container">
                    <canvas id="portfolioChart"></canvas>
                    <div class="doughnut-center">
                        <p class="text-xs text-slate-400 mb-1 font-medium">Total</p>
                        <p class="text-xl font-bold" id="total-value">$0</p>
                        <p class="text-xs text-blue-400 mt-1 font-semibold" id="asset-count">0 assets</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-2 font-medium">Tap coin to trade</p>
                
                <!-- Cash balances moved here from holdings header -->
                <div class="cash-balances-header" style="position:relative;transform:none;left:auto;margin-top:12px;justify-content:center;">
                    <div class="cash-balance-item">
                        <div class="cash-dot usdc-dot"></div>
                        <span class="cash-label">USDC</span>
                        <span class="cash-amount" id="headerUsdcBalance">$0.00</span>
                    </div>
                    <div class="cash-balance-item">
                        <div class="cash-dot aud-dot"></div>
                        <span class="cash-label">AUD</span>
                        <span class="cash-amount" id="headerAudBalance">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="trading-view" id="tradingView">
                
                <div class="trade-header-compact">
                    <div class="header-left">
                        <button class="back-btn" onclick="UI.closeTradingView()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="m15 18-6-6 6-6"/>
                            </svg>
                        </button>
                        <div class="coin-mini">
                            <div class="coin-icon-tiny" id="tradeIcon" style="background: #f9731633; color: #f97316;">₿</div>
                            <span id="tradeName">BTC</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <button class="chart-toggle-btn" id="chartToggleBtn" onclick="UI.toggleMiniChart()" title="Toggle Chart">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                            </svg>
                        </button>
                        
                        <div class="header-actions">
                            <button class="action-btn-mini sell" id="sellBtn" onclick="Trading.prepareTrade('sell')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <path d="M5 12h14"/>
                                </svg>
                                Sell
                            </button>
                            <button class="action-btn-mini buy" id="buyBtn" onclick="Trading.prepareTrade('buy')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Buy
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mini-chart-container" id="miniChartContainer">
                    <div class="mini-chart-box">
                        <canvas id="miniChart"></canvas>
                    </div>
                </div>
                
                <div class="order-toggle">
                    <button class="order-btn active" id="btnInstant" onclick="UI.setOrderType('instant')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                        Instant
                    </button>
                    <button class="order-btn" id="btnTrigger" onclick="UI.setOrderType('trigger')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                        Trigger
                    </button>
                    <button class="order-btn" id="btnAuto" onclick="UI.setOrderType('auto')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        Auto
                    </button>
                </div>
                
                <div class="amount-compact" id="amountSection">
                    <div class="amount-display">
                        <div class="amount-value" id="amountValue">$0.00</div>
                        <div class="amount-conversion" id="conversionText">≈ 0 BTC</div>
                    </div>
                    
                    <div class="slider-box">
                        <div class="slider-track"></div>
                        <div class="slider-fill" id="amountFill" style="width: 0%;"></div>
                        <input type="range" id="amountSlider" min="0" max="100" value="0" step="1" oninput="UI.updateAmountSlider(this.value)">
                    </div>
                    <div class="slider-labels">
                        <span>0%</span>
                        <span id="amountPercent">0%</span>
                        <span>100%</span>
                    </div>
                </div>
                
                                <div class="trigger-compact" id="triggerSection">
                    <div class="trigger-header">
                        <span class="trigger-title">Trigger Order</span>
                        <span class="trigger-reset" onclick="Trading.resetTrigger()">Reset</span>
                    </div>

                    <!-- Step 1: Choose direction -->
                    <div class="limit-toggle" id="limitButtons">
                        <button class="limit-btn buy-limit" id="btnBuyLimit" onclick="Trading.selectLimitType('buy')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Buy Dip
                        </button>
                        <button class="limit-btn sell-limit" id="btnSellLimit" onclick="Trading.selectLimitType('sell')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
                            Sell Rise
                        </button>
                    </div>

                    <!-- Step 2: Configure (shown after direction chosen) -->
                    <div class="hidden" id="triggerConfig">

                        <!-- Direction badge & price in one row -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div class="trigger-direction-badge" id="triggerDirectionBadge" style="margin-bottom:0;">Buy Dip</div>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <div class="trigger-price" style="font-size:20px;" id="triggerPrice">$0.00</div>
                                <div class="trigger-offset" id="triggerOffset">+0%</div>
                            </div>
                        </div>

                        <!-- Two sliders side by side -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            
                            <!-- Price slider -->
                            <div>
                                <div style="font-size:11px;color:#64748b;margin-bottom:4px;text-align:center;">Price</div>
                                <div class="slider-box" style="height:32px;">
                                    <div class="slider-track"></div>
                                    <div class="slider-fill" id="triggerFill" style="width:50%;background:#64748b;"></div>
                                    <input type="range" id="triggerSlider" min="-30" max="0" value="0" step="1" oninput="Trading.updateTriggerSlider(this.value)" style="height:32px;">
                                </div>
                                <div class="slider-labels" style="margin-top:2px;" id="triggerLabels">
                                    <span id="triggerLabelMin">-30%</span>
                                    <span>0%</span>
                                </div>
                            </div>

                            <!-- Amount slider -->
                            <div>
                                <div style="font-size:11px;color:#64748b;margin-bottom:4px;text-align:center;" id="amountSliderLabel">Amount</div>
                                <div class="slider-box" style="height:32px;">
                                    <div class="slider-track"></div>
                                    <div class="slider-fill" id="triggerAmountFill" style="width:0%;background:#3b82f6;"></div>
                                    <input type="range" id="triggerAmountSlider" min="0" max="100" value="0" step="1" oninput="Trading.updateTriggerAmountSlider(this.value)" style="height:32px;">
                                </div>
                                <div class="slider-labels" style="margin-top:2px;">
                                    <span>0%</span>
                                    <span id="triggerAmountPercent">0%</span>
                                </div>
                            </div>

                        </div>

                        <!-- Amount display -->
                        <div style="text-align:center;margin-bottom:8px;">
                            <span style="font-size:13px;color:#94a3b8;" id="triggerAmountDisplay">$0.00</span>
                        </div>

                        <!-- Confirm button -->
                        <button class="confirm-limit-btn" style="margin-top:0;padding:12px;" id="confirmLimitBtn" onclick="Trading.showConfirmModal()">
                            <span id="confirmBtnText">Confirm Buy Trigger</span>
                        </button>

                    </div>

                    <div id="triggerError" class="error-message" style="display:none;margin-top:8px;"></div>
                </div>

                
                <div class="auto-compact" id="autoSection">
                    <div class="auto-header">
                        <span class="auto-title">Auto Trade Settings</span>
                        <span class="auto-reset" onclick="Trading.resetAutoTrade()">Reset</span>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <div class="auto-price-row">
                            <div class="auto-price" id="autoPrice">$0.00</div>
                            <div class="auto-deviation" id="autoDeviation">0%</div>
                        </div>
                        
                        <div id="autoGuide" style="text-align: center; margin-bottom: 6px; font-size: 11px; color: #64748b;">
                            <span id="autoGuideText">Set price deviation</span>
                        </div>
                        
                        <div id="autoError" class="error-message" style="display: none; margin-bottom: 6px;"></div>
                        
                        <div class="slider-box">
                            <div class="slider-track"></div>
                            <div class="slider-fill" id="autoDevFill" style="width: 50%; background: #a855f7;"></div>
                            <input type="range" id="autoDevSlider" min="-20" max="20" value="0" step="1" oninput="Trading.updateAutoDevSlider(this.value)">
                        </div>
                        <div class="slider-labels" id="autoDevLabels">
                            <span>-20%</span>
                            <span>Current</span>
                            <span>+20%</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                        <div class="auto-allocation-row">
                            <span class="auto-allocation-label">Portfolio Allocation</span>
                            <span class="auto-allocation-value" id="autoAllocationValue">0% of 0 USDC</span>
                        </div>
                        
                        <div class="slider-box">
                            <div class="slider-track"></div>
                            <div class="slider-fill" id="autoAllocFill" style="width: 0%; background: #22c55e;"></div>
                            <input type="range" id="autoAllocSlider" min="0" max="100" value="0" step="1" oninput="Trading.updateAutoAllocSlider(this.value)">
                        </div>
                        <div class="slider-labels">
                            <span>0%</span>
                            <span id="autoAllocPercent">0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>

    <div class="holdings-container" id="holdingsContainer">
        <div class="holdings-header">
            <h2 class="text-lg font-bold holdings-title">Holdings</h2>
            
            
            <button onclick="UI.toggleSort()" class="sort-btn">
                <span id="currentSortLabel">Sort: Value</span>
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m6 9 6 6 6-6"/>
                </svg>
            </button>
        </div>
        
        <div id="holdings-list">
            <div style="text-align: center; color: #64748b; padding: 40px;">
                Connecting to Swyftx...
            </div>
        </div>
        
        <div class="last-updated" id="last-updated">Last updated: --</div>
        
        <div class="card" style="margin-top: 20px;">
            <div class="section-title">Activity Log</div>
            <div id="log-container" class="log-container">
                <div class="log-entry">
                    <span class="log-time">[--:--:--]</span>
                    <span class="log-info">Initializing...</span>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="pinModal" class="pin-modal-overlay">
    <div class="pin-modal-content">
        <div class="pin-title">Trading PIN Required</div>
        <div class="pin-subtitle">Enter PIN to enable trading</div>
        <input type="password" id="pinInput" class="pin-input" maxlength="6" placeholder="••••••">
        <div id="pinError" class="pin-error">Invalid PIN</div>
        <button onclick="App.unlockTrading()" class="pin-btn" id="pinBtn">Unlock</button>
    </div>
</div>

<div id="limitConfirmModal" class="trade-modal-overlay">
    <div class="trade-modal-content">
        <div class="trade-modal-title" id="limitModalTitle">Confirm Limit Order</div>
        <div class="trade-modal-details">
            <div class="trade-detail-row">
                <span style="color: #64748b;">Type</span>
                <span id="limitModalType" style="color: white; font-weight: 600;">Buy Limit</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Asset</span>
                <span id="limitModalAsset" style="color: white;">BTC</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Trigger Price</span>
                <span id="limitModalTrigger" style="color: #a855f7;">$0.00</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Amount</span>
                <span id="limitModalAmount" style="color: white;">$0.00</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Receive</span>
                <span id="limitModalReceive" style="color: #22c55e;">0 BTC</span>
            </div>
        </div>
        <div class="trade-modal-buttons">
            <button onclick="Trading.closeLimitModal()" class="trade-modal-btn cancel">Cancel</button>
            <button onclick="Trading.executeLimitOrder()" class="trade-modal-btn confirm" id="limitModalExecuteBtn">Execute</button>
        </div>
    </div>
</div>

<div id="successModal" class="trade-modal-overlay">
    <div class="trade-modal-content" style="text-align: center;">
        <div style="width: 60px; height: 60px; background: #22c55e; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
        </div>
        <div class="trade-modal-title" style="color: #22c55e; margin-bottom: 8px;">Order Placed!</div>
        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">Your limit order has been submitted successfully.</p>
        <button onclick="Trading.closeSuccessModal()" class="trade-modal-btn confirm" style="width: 100%;">Done</button>
    </div>
</div>

<div id="tradeModal" class="trade-modal-overlay">
    <div class="trade-modal-content">
        <div class="trade-modal-title" id="tradeModalTitle">Confirm Trade</div>
        <div class="trade-modal-details">
            <div class="trade-detail-row">
                <span style="color: #64748b;">Type</span>
                <span id="modalOrderType" style="color: white; font-weight: 600;">Instant</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Asset</span>
                <span id="modalAsset" style="color: white;">BTC</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Amount</span>
                <span id="modalAmount" style="color: white;">$0.00 USDC</span>
            </div>
            <div class="trade-detail-row" id="modalTriggerRow" style="display: none;">
                <span style="color: #64748b;">Trigger</span>
                <span id="modalTrigger" style="color: #a855f7;">$0.00</span>
            </div>
            <div class="trade-detail-row">
                <span style="color: #64748b;">Receive</span>
                <span id="modalReceive" style="color: #22c55e;">0 BTC</span>
            </div>
        </div>
        <div class="trade-modal-buttons">
            <button onclick="Trading.cancelTrade()" class="trade-modal-btn cancel">Cancel</button>
            <button onclick="Trading.confirmTrade()" class="trade-modal-btn confirm" id="modalConfirmBtn">Confirm</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="UI.closeSort()"></div>
<div class="sort-modal" id="sortModal">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-base">Sort Holdings</h3>
        <button onclick="UI.closeSort()" class="p-2 rounded-lg hover:bg-slate-700">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="space-y-2">
        <button onclick="UI.selectSort('value')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 text-sm font-medium flex justify-between items-center" id="sort-value">
            <span>Value (High to Low)</span>
            <span id="check-value" class="text-blue-400">✓</span>
        </button>
        <button onclick="UI.selectSort('change')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 text-sm font-medium flex justify-between items-center" id="sort-change">
            <span>% Change (24h)</span>
            <span id="check-change" class="text-blue-400 hidden">✓</span>
        </button>
        <button onclick="UI.selectSort('name')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 text-sm font-medium flex justify-between items-center" id="sort-name">
            <span>Name (A-Z)</span>
            <span id="check-name" class="text-blue-400 hidden">✓</span>
        </button>
        <button onclick="UI.selectSort('balance')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 text-sm font-medium flex justify-between items-center" id="sort-balance">
            <span>Balance (High to Low)</span>
            <span id="check-balance" class="text-blue-400 hidden">✓</span>
        </button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="flex justify-around items-center max-w-lg mx-auto">
        <a href="#" class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
            </svg>
        </a>
        <a href="#" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
            </svg>
        </a>
        <a href="#" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
        </a>
        <a href="#" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        </a>
        <a href="#" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </a>
    </div>
</nav>

<script src="js/config.js"></script>
<script src="js/logger.js"></script>
<script src="js/assets.js"></script>
<script src="js/api.js"></script>
<script src="js/ui.js"></script>
<script src="js/trading.js"></script>
<script src="js/app.js"></script>
</body>
</html>
